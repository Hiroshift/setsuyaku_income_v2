<% if user_signed_in? %>

  <div class="record" data-controller="amount">
    <p class="record-q">いくら節約しましたか？</p>
    <p class="record-display" data-amount-target="display">¥0</p>

    <%= form_with url: new_income_path, method: :post, local: true do |f| %>
      <%= f.hidden_field :amount, value: "", data: { amount_target: "hidden" } %>
      <%= f.hidden_field :recorded_date, value: Date.today.to_s, data: { amount_target: "dateHidden" } %>

      <div class="keypad">
        <button type="button" class="key" data-key="1" data-action="amount#press">1</button>
        <button type="button" class="key" data-key="2" data-action="amount#press">2</button>
        <button type="button" class="key" data-key="3" data-action="amount#press">3</button>
        <button type="button" class="key" data-key="4" data-action="amount#press">4</button>
        <button type="button" class="key" data-key="5" data-action="amount#press">5</button>
        <button type="button" class="key" data-key="6" data-action="amount#press">6</button>
        <button type="button" class="key" data-key="7" data-action="amount#press">7</button>
        <button type="button" class="key" data-key="8" data-action="amount#press">8</button>
        <button type="button" class="key" data-key="9" data-action="amount#press">9</button>
        <button type="button" class="key key--sub" data-key="00" data-action="amount#press">00</button>
        <button type="button" class="key" data-key="0" data-action="amount#press">0</button>
        <button type="button" class="key key--sub" data-action="amount#del">←</button>
      </div>

      <!-- 日付選択 -->
      <div class="date-chips">
        <button type="button" class="date-chip date-chip--active"
                data-date="<%= Date.today.to_s %>"
                data-action="amount#selectDate"
                data-amount-target="dateBtn">今日</button>
        <button type="button" class="date-chip"
                data-date="<%= 1.day.ago.to_date.to_s %>"
                data-action="amount#selectDate"
                data-amount-target="dateBtn">昨日</button>
        <button type="button" class="date-chip"
                data-date="<%= 2.days.ago.to_date.to_s %>"
                data-action="amount#selectDate"
                data-amount-target="dateBtn">一昨日</button>
      </div>

      <!-- メモ -->
      <input type="text" name="note" class="record-note"
             placeholder="何を節約した？（例: 自炊した）"
             maxlength="40"
             autocomplete="off">

      <%= f.submit "収入に変える", class: "record-btn" %>
    <% end %>
  </div>

  <hr class="sep">

  <!-- 今日の節約収入 -->
  <div class="today">
    <p class="today-label">今日の節約収入</p>
    <p class="today-amount">¥<%= number_with_delimiter(@today_income) %></p>
    <% if @total_minutes > 0 %>
      <p class="today-eq">＝ <%= @virtual_work_time %>ぶんの労働</p>
    <% end %>
  </div>

  <!-- リテンション: 連続記録 + 今週 -->
  <% if @streak > 0 || @week_income > 0 %>
    <div class="retention">
      <% if @streak > 0 %>
        <div class="retention-item">
          <span class="retention-num"><%= @streak %></span>
          <span class="retention-label">日連続</span>
        </div>
      <% end %>
      <% if @week_income > 0 %>
        <div class="retention-item">
          <span class="retention-num">¥<%= number_with_delimiter(@week_income) %></span>
          <span class="retention-label">今週の収入<% if @last_week_income > 0 && @week_income > @last_week_income %> ↑<% end %></span>
        </div>
      <% end %>
      <% if @week_minutes > 0 %>
        <div class="retention-item">
          <span class="retention-num"><%= @week_time %></span>
          <span class="retention-label">今週の労働換算</span>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if !@yesterday_recorded && @total_income > 0 %>
    <p class="yesterday-nudge">昨日の記録がありません。忘れていませんか？</p>
  <% end %>

  <hr class="sep">

  <!-- 累計 -->
  <div class="life">
    <p class="life-above">これまでの節約収入</p>
    <p class="life-num life-num--plain">¥<%= number_with_delimiter(@total_income) %></p>
    <% if @lifetime_minutes > 0 %>
      <p class="life-eq">＝ <%= @lifetime_display %>ぶんの労働</p>
      <% if current_user.premium? && @annual_projection.present? %>
        <p class="life-below">年末まで<%= @annual_projection %>ペース</p>
      <% end %>
    <% end %>
  </div>

  <% if @lifetime_minutes > 0 && current_user.premium? && @total_minutes > 0 %>
    <%= turbo_frame_tag "ai_suggestion" do %>
        <%= button_to "この時間で何ができる？ →", suggest_path,
            class: "ai-text-link",
            data: { turbo_frame: "ai_suggestion" } %>
    <% end %>
  <% end %>

  <% unless current_user.premium? %>
    <hr class="sep">
    <%= render "shared/premium_gate" %>
  <% end %>

<% else %>

  <div class="hero">
    <p class="hero-kicker">気づいていますか？</p>
    <h2 class="hero-big">節約は、収入だ。</h2>
    <p class="hero-body">
      あなたが働いて得る1時間の給料。<br>
      節約した金額には、同じ価値がある。
    </p>

    <p class="hero-rate">時給 ¥1,200 の場合</p>

    <div class="hero-examples">
      <div class="hero-example">
        <span class="hero-example-scene">コンビニ弁当 → 自炊</span>
        <span class="hero-example-result">¥500 → <strong>25分</strong>ぶんの収入</span>
      </div>
      <div class="hero-example">
        <span class="hero-example-scene">タクシー → 電車</span>
        <span class="hero-example-result">¥1,200 → <strong>1時間</strong>ぶんの収入</span>
      </div>
      <div class="hero-example">
        <span class="hero-example-scene">1ヶ月続けると</span>
        <span class="hero-example-result">→ <strong>まる1日</strong>ぶんの収入</span>
      </div>
    </div>

    <%= link_to "自分の時間を知る →", new_user_registration_path, class: "hero-cta" %>

    <div class="hero-how">
      <p class="hero-how-title">使い方は、たった3ステップ</p>
      <div class="hero-steps">
        <div class="hero-step">
          <span class="hero-step-num">1</span>
          <span class="hero-step-text">時給を設定</span>
        </div>
        <div class="hero-step">
          <span class="hero-step-num">2</span>
          <span class="hero-step-text">節約額を入力</span>
        </div>
        <div class="hero-step">
          <span class="hero-step-num">3</span>
          <span class="hero-step-text">収入が見える</span>
        </div>
      </div>
    </div>

    <p class="hero-footer">我慢じゃない。意識的な選択だ。</p>
  </div>

<% end %>
